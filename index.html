<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Auto Ladekosten - Gemeinsame Abrechnung</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .mode-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-top: 10px;
        }

        .mode-simulation {
            background: #fef3c7;
            color: #92400e;
        }

        .mode-live {
            background: #d1fae5;
            color: #065f46;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .grid-single {
            display: block;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .stat {
            margin-bottom: 20px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-unit {
            font-size: 0.5em;
            color: #999;
            margin-left: 5px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button.secondary {
            background: #10b981;
        }

        button.secondary:hover {
            background: #059669;
        }

        button.danger {
            background: #ef4444;
        }

        button.danger:hover {
            background: #dc2626;
        }

        .btn-primary {
            background: #667eea;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 10px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: 500;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .history-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .history-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .history-table tr:hover {
            background: #f8f9fa;
        }

        .tariff-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .tariff-high {
            background: #fef3c7;
            color: #92400e;
        }

        .tariff-low {
            background: #dbeafe;
            color: #1e40af;
        }

        .chart-container {
            margin-top: 20px;
            height: 220px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            padding-top: 50px;
            display: flex;
            align-items: flex-end;
            gap: 5px;
        }

        .chart-bar {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px 4px 0 0;
            min-height: 5px;
            position: relative;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .chart-label {
            position: absolute;
            bottom: -20px;
            font-size: 0.8em;
            color: #666;
        }

        .info-box {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
        }

        .info-box h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .info-box p {
            color: #666;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° E-Auto Ladekosten Tracker</h1>
            <p style="color: #666;">Transparente Abrechnung f√ºr Familie Br√§uer, Odermatt & St√§heli</p>
            <div id="modeBadge" class="mode-badge mode-simulation">üéÆ Simulationsmodus</div>
        </div>

        <div class="card">
            <h2>‚öôÔ∏è Einstellungen</h2>
            <div style="display: grid; gap: 15px;">
                <div>
                    <label>Modus:</label>
                    <select id="modeSelect">
                        <option value="simulation">üéÆ Simulation (Demo-Daten)</option>
                        <option value="live">‚ö° Live (Shelly 3EM)</option>
                    </select>
                </div>
                <div>
                    <label>Hochtarif (Tag, 7-22 Uhr) CHF/kWh:</label>
                    <input type="number" id="priceHighInput" step="0.0001" value="0.1668">
                </div>
                <div>
                    <label>Niedertarif (Nacht, 22-7 Uhr) CHF/kWh:</label>
                    <input type="number" id="priceLowInput" step="0.0001" value="0.1606">
                </div>
                <div id="shellySettings" style="display: none;">
                    <label>Shelly 3EM IP-Adresse:</label>
                    <input type="text" id="shellyIp" placeholder="192.168.1.100">
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button onclick="saveSettings()">üíæ Einstellungen speichern</button>
                <button class="secondary" onclick="addManualCharge()">‚ûï Ladevorgang manuell hinzuf√ºgen</button>
                <button class="secondary" onclick="markAsPaid()">‚úÖ Als bezahlt markieren</button>
                <button class="danger" onclick="resetData()">üóëÔ∏è Alle Daten zur√ºcksetzen</button>
            </div>

            <div class="info-box">
                <h3>‚ÑπÔ∏è Wie funktioniert das?</h3>
                <p><strong>Simulationsmodus:</strong> Generiert automatisch realistische Ladedaten zum Testen. Perfekt zum Ausprobieren!<br>
                <strong>Live-Modus:</strong> Verbindet sich mit deinem Shelly 3EM und zeigt echte Verbrauchsdaten an.<br>
                <strong>Als bezahlt markieren:</strong> Speichert die Kosten in der Monats√ºbersicht und setzt den Abrechnungszeitraum zur√ºck.</p>
            </div>
        </div>

        <div class="card grid-single">
            <h2>üìä Aktueller Abrechnungszeitraum</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                <div class="stat">
                    <div class="stat-label">Gesamtverbrauch</div>
                    <div class="stat-value" id="totalKwh">0<span class="stat-unit">kWh</span></div>
                </div>
                <div class="stat">
                    <div class="stat-label">Gesamtkosten</div>
                    <div class="stat-value" id="totalCost">0.00<span class="stat-unit">CHF</span></div>
                </div>
                <div class="stat">
                    <div class="stat-label">Anzahl Ladevorg√§nge</div>
                    <div class="stat-value" id="chargeCount">0</div>
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familie Br√§uer</h2>
                <div class="stat">
                    <div class="stat-label">Anteil (‚Öì der Kosten)</div>
                    <div class="stat-value" id="brauerCost">0.00<span class="stat-unit">CHF</span></div>
                </div>
                <div class="stat">
                    <div class="stat-label">Status</div>
                    <div style="color: #ef4444; margin-top: 5px; font-size: 1.1em; font-weight: 600;" id="brauerStatus">Ausstehend</div>
                </div>
            </div>

            <div class="card">
                <h2>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familie Odermatt</h2>
                <div class="stat">
                    <div class="stat-label">Anteil (‚Öì der Kosten)</div>
                    <div class="stat-value" id="odermattCost">0.00<span class="stat-unit">CHF</span></div>
                </div>
                <div class="stat">
                    <div class="stat-label">Status</div>
                    <div style="color: #ef4444; margin-top: 5px; font-size: 1.1em; font-weight: 600;" id="odermattStatus">Ausstehend</div>
                </div>
            </div>

            <div class="card">
                <h2>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familie St√§heli</h2>
                <div class="stat">
                    <div class="stat-label">Anteil (‚Öì der Kosten)</div>
                    <div class="stat-value" id="staeheliCost">0.00<span class="stat-unit">CHF</span></div>
                </div>
                <div class="stat">
                    <div class="stat-label">Status</div>
                    <div style="color: #ef4444; margin-top: 5px; font-size: 1.1em; font-weight: 600;" id="staeheliStatus">Ausstehend</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üìà Letzter Ladevorgang & Durchschnitt</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <div>
                    <div style="color: #666; margin-bottom: 10px;">Letzter Ladevorgang:</div>
                    <div id="lastCharge" style="font-size: 1.2em; font-weight: 600; color: #667eea;">-</div>
                </div>
                <div>
                    <div style="color: #666; margin-bottom: 10px;">Durchschnitt pro Ladung:</div>
                    <div id="avgCharge" style="font-size: 1.2em; font-weight: 600; color: #667eea;">-</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üìÖ Letzter Reset</h2>
            <div id="lastReset" style="font-size: 1.1em; color: #666;">Noch nie zur√ºckgesetzt</div>
        </div>

        <div class="card">
            <h2>üìä Verbrauch letzte 7 Tage</h2>
            <div class="chart-container" id="chartContainer"></div>
        </div>

        <div class="card">
            <h2>üí∞ Gesamtkosten nach Monat (Alle Familien)</h2>
            <p style="color: #666; margin-bottom: 15px;">Monatliche √úbersicht aller Ladekosten √ºber alle Abrechnungszeitr√§ume hinweg</p>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Monat</th>
                        <th>Anzahl Zahlungen</th>
                        <th>Verbrauch (kWh)</th>
                        <th>Gesamtkosten (CHF)</th>
                    </tr>
                </thead>
                <tbody id="monthlyStatsTable">
                    <tr>
                        <td colspan="4" style="text-align: center; color: #999;">Noch keine Zahlungen erfasst</td>
                    </tr>
                </tbody>
            </table>
            <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <strong>Gesamtsumme (alle Monate):</strong>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
                    <div>
                        <div style="color: #666; font-size: 0.9em;">Gesamt Verbrauch</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #667eea;" id="totalAllKwh">0 kWh</div>
                    </div>
                    <div>
                        <div style="color: #666; font-size: 0.9em;">Gesamtkosten (alle 3 Familien)</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #667eea;" id="totalAllCost">0.00 CHF</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üìã Ladevorg√§nge Historie</h2>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Datum & Zeit</th>
                        <th>Verbrauch (kWh)</th>
                        <th>Tarif</th>
                        <th>Kosten</th>
                    </tr>
                </thead>
                <tbody id="chargesTable">
                    <tr>
                        <td colspan="4" style="text-align: center; color: #999;">Keine Ladevorg√§nge</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Supabase Client Library -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        // ============================================
        // SUPABASE KONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://fgvjxgcgbdzuewukxedo.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZndmp4Z2NnYmR6dWV3dWt4ZWRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MTE3MTksImV4cCI6MjA3OTk4NzcxOX0.DhWTfgz9nfpt1OHbUJiETWkIwVU4lk6FweEHZl0stDg'
        const INSTALLATION_ID = 'braeuer-odermatt-staeheli-bremgarten'
        
        // Initialize Supabase
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        console.log('‚úÖ Supabase connected:', SUPABASE_URL)
        
        // ============================================
        // DATA STORAGE
        // ============================================
        let charges = []
        let paymentHistory = []
        let settings = {
            mode: 'simulation',
            priceHigh: 0.1668,
            priceLow: 0.1606,
            shellyIp: '',
            lastReset: null
        }

        // Get tariff based on time
        function getTariff(date) {
            const hour = new Date(date).getHours()
            if (hour >= 7 && hour < 22) {
                return { type: 'high', price: settings.priceHigh }
            } else {
                return { type: 'low', price: settings.priceLow }
            }
        }

        // Load data from Supabase
        async function loadData() {
            try {
                // Load settings from localStorage
                const savedSettings = localStorage.getItem('evSettings')
                if (savedSettings) {
                    const parsed = JSON.parse(savedSettings)
                    settings = { ...settings, ...parsed }
                    document.getElementById('modeSelect').value = settings.mode
                    document.getElementById('priceHighInput').value = settings.priceHigh || 0.1668
                    document.getElementById('priceLowInput').value = settings.priceLow || 0.1606
                    document.getElementById('shellyIp').value = settings.shellyIp || ''
                    updateModeDisplay()
                }
                
                // Load charges from Supabase
                const { data: chargesData, error: chargesError } = await supabaseClient
                    .from('charges')
                    .select('*')
                    .eq('installation_id', INSTALLATION_ID)
                    .order('date', { ascending: false })
                
                if (chargesError) {
                    console.error('Error loading charges:', chargesError)
                } else {
                    charges = chargesData || []
                    console.log(`Loaded ${charges.length} charges from Supabase`)
                }
                
                // Load payment history from Supabase
                const { data: paymentsData, error: paymentsError } = await supabaseClient
                    .from('payment_history')
                    .select('*')
                    .eq('installation_id', INSTALLATION_ID)
                    .order('payment_date', { ascending: false })
                
                if (paymentsError) {
                    console.error('Error loading payments:', paymentsError)
                } else {
                    paymentHistory = paymentsData || []
                    console.log(`Loaded ${paymentHistory.length} payments from Supabase`)
                }
                
                // If in simulation mode and no data, generate some
                if (settings.mode === 'simulation' && charges.length === 0) {
                    await generateSimulationData()
                    await generateDemoPaymentHistory()
                }
                
                updateDisplay()
            } catch (error) {
                console.error('Error in loadData:', error)
                alert('Fehler beim Laden der Daten. Bitte √ºberpr√ºfe deine Supabase-Konfiguration.')
            }
        }

        // Save settings
        function saveSettings() {
            settings.mode = document.getElementById('modeSelect').value
            settings.priceHigh = parseFloat(document.getElementById('priceHighInput').value)
            settings.priceLow = parseFloat(document.getElementById('priceLowInput').value)
            settings.shellyIp = document.getElementById('shellyIp').value
            
            localStorage.setItem('evSettings', JSON.stringify(settings))
            updateModeDisplay()
            updateDisplay()
            
            alert('‚úÖ Einstellungen gespeichert!')
        }

        // Generate simulation data
        async function generateSimulationData() {
            const today = new Date()
            const newCharges = []
            
            for (let daysAgo = 6; daysAgo >= 0; daysAgo--) {
                const chargesPerDay = Math.floor(Math.random() * 3)
                
                for (let i = 0; i < chargesPerDay; i++) {
                    const date = new Date(today)
                    date.setDate(date.getDate() - daysAgo)
                    
                    if (i === 0) {
                        date.setHours(18 + Math.floor(Math.random() * 6))
                    } else {
                        date.setHours(7 + Math.floor(Math.random() * 6))
                    }
                    date.setMinutes(Math.floor(Math.random() * 60))
                    
                    const kwh = (Math.random() * 10 + 10).toFixed(2)
                    const tariff = getTariff(date)
                    
                    newCharges.push({
                        installation_id: INSTALLATION_ID,
                        date: date.toISOString(),
                        kwh: parseFloat(kwh),
                        tariff: tariff.type,
                        price: tariff.price
                    })
                }
            }
            
            if (newCharges.length > 0) {
                const { data, error } = await supabaseClient
                    .from('charges')
                    .insert(newCharges)
                    .select()
                
                if (error) {
                    console.error('Error saving simulation data:', error)
                } else {
                    charges = data.sort((a, b) => new Date(b.date) - new Date(a.date))
                    console.log(`‚úÖ Generated ${charges.length} demo charges`)
                }
            }
        }

        // Generate demo payment history
        async function generateDemoPaymentHistory() {
            const now = new Date()
            const newPayments = []
            
            for (let i = 0; i < 3; i++) {
                const monthsAgo = i + 1
                const paymentDate = new Date(now)
                paymentDate.setMonth(paymentDate.getMonth() - monthsAgo)
                
                const numCharges = Math.floor(Math.random() * 10) + 8
                const totalKwh = (Math.random() * 100 + 150).toFixed(2)
                const avgPrice = (settings.priceHigh + settings.priceLow) / 2
                const totalCost = parseFloat(totalKwh) * avgPrice
                const costPerParty = totalCost / 3
                
                newPayments.push({
                    installation_id: INSTALLATION_ID,
                    payment_date: paymentDate.toISOString(),
                    total_kwh: parseFloat(totalKwh),
                    total_cost: totalCost,
                    cost_per_party: costPerParty,
                    charge_count: numCharges
                })
            }
            
            if (newPayments.length > 0) {
                const { data, error } = await supabaseClient
                    .from('payment_history')
                    .insert(newPayments)
                    .select()
                
                if (error) {
                    console.error('Error saving demo payments:', error)
                } else {
                    paymentHistory = data.sort((a, b) => new Date(b.payment_date) - new Date(a.payment_date))
                    console.log(`‚úÖ Generated ${paymentHistory.length} demo payments`)
                }
            }
        }

        // Add manual charge
        async function addManualCharge() {
            const kwh = prompt('Verbrauch in kWh eingeben:')
            if (!kwh || isNaN(kwh) || parseFloat(kwh) <= 0) {
                return
            }
            
            const timeStr = prompt('Uhrzeit eingeben (HH:MM, z.B. 14:30):\n(Leer lassen f√ºr aktuelle Zeit)')
            let chargeDate = new Date()
            
            if (timeStr && timeStr.trim() !== '') {
                const timeParts = timeStr.split(':')
                if (timeParts.length === 2) {
                    const hours = parseInt(timeParts[0])
                    const minutes = parseInt(timeParts[1])
                    if (!isNaN(hours) && !isNaN(minutes) && hours >= 0 && hours < 24 && minutes >= 0 && minutes < 60) {
                        chargeDate.setHours(hours, minutes, 0, 0)
                    }
                }
            }
            
            const tariff = getTariff(chargeDate)
            const tariffName = tariff.type === 'high' ? 'Hochtarif (Tag)' : 'Niedertarif (Nacht)'
            
            const newCharge = {
                installation_id: INSTALLATION_ID,
                date: chargeDate.toISOString(),
                kwh: parseFloat(kwh),
                tariff: tariff.type,
                price: tariff.price
            }
            
            const { data, error } = await supabaseClient
                .from('charges')
                .insert([newCharge])
                .select()
            
            if (error) {
                console.error('Error saving charge:', error)
                alert('‚ùå Fehler beim Speichern!')
            } else {
                charges.unshift(data[0])
                updateDisplay()
                alert(`‚úÖ Ladevorgang hinzugef√ºgt!\nTarif: ${tariffName} (${tariff.price.toFixed(4)} CHF/kWh)`)
            }
        }

        // Mark as paid
        async function markAsPaid() {
            let relevantCharges = charges
            if (settings.lastReset) {
                const resetDate = new Date(settings.lastReset)
                relevantCharges = charges.filter(c => new Date(c.date) > resetDate)
            }
            
            if (relevantCharges.length === 0) {
                alert('‚ÑπÔ∏è Es gibt keine ausstehenden Kosten zum Bezahlen.')
                return
            }
            
            const totalKwh = relevantCharges.reduce((sum, c) => sum + c.kwh, 0)
            
            const totalCost = relevantCharges.reduce((sum, c) => {
                let price = c.price
                if (!c.tariff) {
                    const date = new Date(c.date)
                    const tariff = getTariff(date)
                    price = tariff.price
                }
                return sum + (c.kwh * price)
            }, 0)
            
            const costPerParty = totalCost / 3
            
            if (costPerParty === 0) {
                alert('‚ÑπÔ∏è Es gibt keine ausstehenden Kosten zum Bezahlen.')
                return
            }
            
            const message = `Folgende Betr√§ge als bezahlt markieren?\n\n` +
                           `Familie Br√§uer: CHF ${costPerParty.toFixed(2)}\n` +
                           `Familie Odermatt: CHF ${costPerParty.toFixed(2)}\n` +
                           `Familie St√§heli: CHF ${costPerParty.toFixed(2)}\n\n` +
                           `Gesamt: CHF ${totalCost.toFixed(2)} (${totalKwh.toFixed(2)} kWh)\n\n` +
                           `Die Zahlung wird in der Gesamtkosten-√úbersicht gespeichert.`
            
            if (confirm(message)) {
                const newPayment = {
                    installation_id: INSTALLATION_ID,
                    payment_date: new Date().toISOString(),
                    total_kwh: totalKwh,
                    total_cost: totalCost,
                    cost_per_party: costPerParty,
                    charge_count: relevantCharges.length
                }
                
                const { data, error } = await supabaseClient
                    .from('payment_history')
                    .insert([newPayment])
                    .select()
                
                if (error) {
                    console.error('Error saving payment:', error)
                    alert('‚ùå Fehler beim Speichern der Zahlung!')
                } else {
                    paymentHistory.unshift(data[0])
                    settings.lastReset = new Date().toISOString()
                    localStorage.setItem('evSettings', JSON.stringify(settings))
                    updateDisplay()
                    alert('‚úÖ Kosten als bezahlt markiert und in Gesamtkosten-√úbersicht gespeichert!\n\nDer Abrechnungszeitraum wurde zur√ºckgesetzt.')
                }
            }
        }

        // Reset data
        async function resetData() {
            if (confirm('‚ö†Ô∏è Wirklich alle Daten l√∂schen? Dies l√∂scht auch die Gesamtkosten-√úbersicht! Dies kann nicht r√ºckg√§ngig gemacht werden!')) {
                try {
                    const { error: chargesError } = await supabaseClient
                        .from('charges')
                        .delete()
                        .eq('installation_id', INSTALLATION_ID)
                    
                    if (chargesError) throw chargesError
                    
                    const { error: paymentsError } = await supabaseClient
                        .from('payment_history')
                        .delete()
                        .eq('installation_id', INSTALLATION_ID)
                    
                    if (paymentsError) throw paymentsError
                    
                    charges = []
                    paymentHistory = []
                    settings.lastReset = null
                    
                    if (settings.mode === 'simulation') {
                        await generateSimulationData()
                        await generateDemoPaymentHistory()
                    }
                    
                    localStorage.setItem('evSettings', JSON.stringify(settings))
                    updateDisplay()
                    
                    if (settings.mode === 'simulation') {
                        alert('‚úÖ Alle Daten wurden zur√ºckgesetzt und neue Demo-Daten generiert!')
                    } else {
                        alert('‚úÖ Alle Daten wurden gel√∂scht!')
                    }
                } catch (error) {
                    console.error('Error resetting data:', error)
                    alert('‚ùå Fehler beim L√∂schen der Daten!')
                }
            }
        }

        // Update mode display
        function updateModeDisplay() {
            const badge = document.getElementById('modeBadge')
            const shellySettings = document.getElementById('shellySettings')
            
            if (settings.mode === 'simulation') {
                badge.textContent = 'üéÆ Simulationsmodus'
                badge.className = 'mode-badge mode-simulation'
                shellySettings.style.display = 'none'
            } else {
                badge.textContent = '‚ö° Live-Modus'
                badge.className = 'mode-badge mode-live'
                shellySettings.style.display = 'block'
            }
        }

        // Update display
        function updateDisplay() {
            let relevantCharges = charges
            if (settings.lastReset) {
                const resetDate = new Date(settings.lastReset)
                relevantCharges = charges.filter(c => new Date(c.date) > resetDate)
            }
            
            const totalKwh = relevantCharges.reduce((sum, c) => sum + c.kwh, 0)
            const totalCost = relevantCharges.reduce((sum, c) => {
                let price = c.price
                if (!c.tariff) {
                    const tariff = getTariff(new Date(c.date))
                    price = tariff.price
                }
                return sum + (c.kwh * price)
            }, 0)
            const costPerParty = totalCost / 3
            
            document.getElementById('totalKwh').innerHTML = `${totalKwh.toFixed(2)}<span class="stat-unit">kWh</span>`
            document.getElementById('totalCost').innerHTML = `${totalCost.toFixed(2)}<span class="stat-unit">CHF</span>`
            document.getElementById('chargeCount').textContent = relevantCharges.length
            
            document.getElementById('brauerCost').innerHTML = `${costPerParty.toFixed(2)}<span class="stat-unit">CHF</span>`
            document.getElementById('odermattCost').innerHTML = `${costPerParty.toFixed(2)}<span class="stat-unit">CHF</span>`
            document.getElementById('staeheliCost').innerHTML = `${costPerParty.toFixed(2)}<span class="stat-unit">CHF</span>`
            
            const statusText = costPerParty > 0 ? 'Ausstehend' : 'Bezahlt'
            const statusColor = costPerParty > 0 ? '#ef4444' : '#10b981'
            document.getElementById('brauerStatus').style.color = statusColor
            document.getElementById('brauerStatus').textContent = statusText
            document.getElementById('odermattStatus').style.color = statusColor
            document.getElementById('odermattStatus').textContent = statusText
            document.getElementById('staeheliStatus').style.color = statusColor
            document.getElementById('staeheliStatus').textContent = statusText
            
            if (charges.length > 0) {
                const lastCharge = charges[0]
                const lastDate = new Date(lastCharge.date).toLocaleString('de-CH')
                document.getElementById('lastCharge').textContent = `${lastCharge.kwh.toFixed(2)} kWh am ${lastDate}`
                
                const avgKwh = charges.reduce((sum, c) => sum + c.kwh, 0) / charges.length
                document.getElementById('avgCharge').textContent = `${avgKwh.toFixed(2)} kWh`
            } else {
                document.getElementById('lastCharge').textContent = '-'
                document.getElementById('avgCharge').textContent = '-'
            }
            
            if (settings.lastReset) {
                const resetDate = new Date(settings.lastReset)
                const daysSince = Math.floor((new Date() - resetDate) / (1000 * 60 * 60 * 24))
                document.getElementById('lastReset').textContent = `${resetDate.toLocaleDateString('de-CH')} (vor ${daysSince} Tagen)`
            } else {
                document.getElementById('lastReset').textContent = 'Noch nie zur√ºckgesetzt'
            }
            
            updateChart()
            updateChargesTable()
            updateMonthlyStats()
        }

        // Update chart
        function updateChart() {
            const container = document.getElementById('chartContainer')
            const last7Days = []
            const today = new Date()
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today)
                date.setDate(date.getDate() - i)
                date.setHours(0, 0, 0, 0)
                
                const dayCharges = charges.filter(c => {
                    const cd = new Date(c.date)
                    cd.setHours(0, 0, 0, 0)
                    return cd.getTime() === date.getTime()
                })
                
                const totalKwh = dayCharges.reduce((sum, c) => sum + c.kwh, 0)
                const totalCost = dayCharges.reduce((sum, c) => {
                    let price = c.price
                    if (!c.tariff) {
                        const tariff = getTariff(new Date(c.date))
                        price = tariff.price
                    }
                    return sum + (c.kwh * price)
                }, 0)
                
                last7Days.push({ date, kwh: totalKwh, cost: totalCost })
            }
            
            const maxKwh = Math.max(...last7Days.map(d => d.kwh), 1)
            
            container.innerHTML = last7Days.map(d => {
                const height = (d.kwh / maxKwh) * 100
                const day = d.date.toLocaleDateString('de-DE', {weekday: 'short'})
                const kwhDisplay = d.kwh > 0 ? d.kwh.toFixed(1) + ' kWh' : '-'
                const costDisplay = d.cost > 0 ? d.cost.toFixed(2) + ' CHF' : '-'
                return `
                    <div class="chart-bar" style="height: ${height}%; position: relative;">
                        <div style="position: absolute; top: -40px; left: 50%; transform: translateX(-50%); font-size: 0.75em; font-weight: 600; color: #667eea; white-space: nowrap;">${kwhDisplay}</div>
                        <div style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 0.7em; color: #764ba2; white-space: nowrap;">${costDisplay}</div>
                        <div class="chart-label">${day}</div>
                    </div>
                `
            }).join('')
        }

        // Update charges table
        function updateChargesTable() {
            const tbody = document.getElementById('chargesTable')
            
            if (charges.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">Keine Ladevorg√§nge</td></tr>'
                return
            }
            
            tbody.innerHTML = charges.slice(0, 20).map(charge => {
                const date = new Date(charge.date).toLocaleString('de-CH')
                const tariffClass = charge.tariff === 'high' ? 'tariff-high' : 'tariff-low'
                const tariffLabel = charge.tariff === 'high' ? 'HT (Tag)' : 'NT (Nacht)'
                const cost = (charge.kwh * charge.price).toFixed(2)
                
                return `
                    <tr>
                        <td>${date}</td>
                        <td>${charge.kwh.toFixed(2)}</td>
                        <td><span class="tariff-badge ${tariffClass}">${tariffLabel}</span></td>
                        <td>CHF ${cost}</td>
                    </tr>
                `
            }).join('')
        }

        // Update monthly statistics
        function updateMonthlyStats() {
            const tbody = document.getElementById('monthlyStatsTable')
            
            if (paymentHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">Noch keine Zahlungen erfasst</td></tr>'
                document.getElementById('totalAllKwh').textContent = '0 kWh'
                document.getElementById('totalAllCost').textContent = '0.00 CHF'
                return
            }
            
            const monthlyData = {}
            
            paymentHistory.forEach(payment => {
                const date = new Date(payment.payment_date || payment.date)
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        date: date,
                        count: 0,
                        totalKwh: 0,
                        totalCost: 0
                    }
                }
                
                monthlyData[monthKey].count++
                monthlyData[monthKey].totalKwh += payment.total_kwh || payment.totalKwh || 0
                monthlyData[monthKey].totalCost += payment.total_cost || payment.totalCost || 0
            })
            
            const sortedMonths = Object.entries(monthlyData)
                .sort((a, b) => b[1].date - a[1].date)
            
            let totalKwh = 0
            let totalAllCost = 0
            
            tbody.innerHTML = sortedMonths.map(([monthKey, data]) => {
                totalKwh += data.totalKwh
                totalAllCost += data.totalCost
                
                const monthName = data.date.toLocaleDateString('de-CH', { year: 'numeric', month: 'long' })
                
                return `
                    <tr>
                        <td>${monthName}</td>
                        <td>${data.count}</td>
                        <td>${data.totalKwh.toFixed(2)}</td>
                        <td><strong>${data.totalCost.toFixed(2)}</strong></td>
                    </tr>
                `
            }).join('')
            
            document.getElementById('totalAllKwh').textContent = totalKwh.toFixed(2) + ' kWh'
            document.getElementById('totalAllCost').textContent = totalAllCost.toFixed(2) + ' CHF'
        }

        // Initialize
        loadData()
        
        // Mode selector change
        document.getElementById('modeSelect').addEventListener('change', function() {
            if (this.value === 'simulation' && charges.length === 0) {
                if (confirm('M√∂chten Sie Demo-Daten generieren?')) {
                    generateSimulationData()
                    updateDisplay()
                }
            }
        })
    </script>
</body>
</html>
